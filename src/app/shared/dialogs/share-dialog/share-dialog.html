<app-base-dialog
  #dialog
  [visible]="visible()"
  (visibleChange)="visible.set($event)"
  title="Partager"
  [subtitle]="itemName()"
  icon="fa-duotone fa-solid fa-share-nodes"
  [showFooter]="false"
  width="500px">

  <div class="share-dialog-content">
    <!-- Add new permission -->
    <div class="add-permission-section">
      <h4 class="section-title">Ajouter un accès</h4>
      <div class="add-permission-form">
        <div class="email-input-wrapper">
          <input
            type="email"
            pInputText
            placeholder="Entrez une adresse email..."
            [ngModel]="newEmail()"
            (ngModelChange)="newEmail.set($event)"
            (keydown)="onKeyDown($event)"
            [class.p-invalid]="newEmail().length > 0 && !hasValidEmail()" />
        </div>
        <p-select
          [options]="roleOptions"
          [ngModel]="newRole()"
          (ngModelChange)="newRole.set($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Rôle"
          appendTo="body"
          styleClass="role-select" />
        <p-button
          icon="fa-solid fa-plus"
          [disabled]="!hasValidEmail() || addingPermission()"
          [loading]="addingPermission()"
          (click)="addPermission()"
          pTooltip="Ajouter" />
      </div>
    </div>

    <!-- Current permissions -->
    <div class="permissions-section">
      @if (loading()) {
        <div class="loading-state">
          <p-progressSpinner strokeWidth="4" [style]="{ width: '30px', height: '30px' }" />
          <span>Chargement des permissions...</span>
        </div>
      } @else {
        <!-- Own permissions -->
        @if (ownPermissions().length > 0) {
          <h4 class="section-title">Accès directs</h4>
          <div class="permissions-list">
            @for (perm of ownPermissions(); track perm._id) {
              <div class="permission-item">
                <div class="permission-info">
                  <div class="permission-icon">
                    <i [class]="getPrincipalIcon(perm.principalType)"></i>
                  </div>
                  <div class="permission-details">
                    <span class="permission-name">{{ perm.principalName || perm.principalId }}</span>
                    <span class="permission-type">{{ perm.principalType === 'team' ? 'Équipe' : 'Utilisateur' }}</span>
                  </div>
                </div>
                <div class="permission-actions">
                  <p-tag
                    [value]="getRoleLabel(perm.role)"
                    [severity]="getRoleSeverity(perm.role)" />
                  <p-button
                    icon="fa-solid fa-trash"
                    severity="danger"
                    [text]="true"
                    size="small"
                    (click)="removePermission(perm)"
                    pTooltip="Supprimer l'accès" />
                </div>
              </div>
            }
          </div>
        }

        <!-- Inherited permissions (folders only) -->
        @if (inheritedPermissions().length > 0) {
          <h4 class="section-title inherited">
            <i class="fa-duotone fa-solid fa-arrow-up"></i>
            Accès hérités
          </h4>
          <div class="permissions-list inherited">
            @for (perm of inheritedPermissions(); track perm._id) {
              <div class="permission-item inherited">
                <div class="permission-info">
                  <div class="permission-icon">
                    <i [class]="getPrincipalIcon(perm.principalType)"></i>
                  </div>
                  <div class="permission-details">
                    <span class="permission-name">{{ perm.principalName || perm.principalId }}</span>
                    <span class="permission-type">{{ perm.principalType === 'team' ? 'Équipe' : 'Utilisateur' }}</span>
                  </div>
                </div>
                <div class="permission-actions">
                  <p-tag
                    [value]="getRoleLabel(perm.role)"
                    [severity]="getRoleSeverity(perm.role)" />
                </div>
              </div>
            }
          </div>
        }

        <!-- Empty state -->
        @if (ownPermissions().length === 0 && inheritedPermissions().length === 0) {
          <div class="empty-state">
            <i class="fa-duotone fa-solid fa-lock"></i>
            <p>Aucun accès partagé</p>
            <span>Ajoutez des personnes ou des équipes pour partager cet élément.</span>
          </div>
        }
      }
    </div>
  </div>
</app-base-dialog>
