<div class="folders-tab">
  <div class="documents-toolbar">
    <div class="toolbar-left">
      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="fa-duotone fa-solid fa-magnifying-glass"></i>
        </p-inputgroup-addon>
        <input
          type="text"
          pInputText
          placeholder="Rechercher"
          [ngModel]="searchQuery()"
          (ngModelChange)="onSearchChange($event)"
          pSize="small" />
      </p-inputgroup>

      <p-divider layout="vertical" />

      <p-select
        [options]="filterOptions"
        [ngModel]="filterType()"
        (ngModelChange)="onFilterChange($event)"
        optionLabel="label"
        optionValue="value"
        size="small"
        appendTo="body"/>

      <p-button
        label="Filtrer"
        icon="fa-duotone fa-solid fa-filter"
        size="small"
        severity="secondary"
        text />

      <p-divider layout="vertical" />

      <p-button
        [label]="displayMode() === 'table' ? 'Vue galerie' : 'Vue tableau'"
        [icon]="displayMode() === 'table' ? 'fa-duotone fa-solid fa-grid-2' : 'fa-duotone fa-solid fa-table'"
        size="small"
        severity="secondary"
        text
        (click)="toggleDisplayMode()" />
    </div>

    <div class="toolbar-right">
      <p-menu #addMenu [model]="addMenuItems" [popup]="true" />
      <p-button
        label="Nouveau dossier"
        icon="fa-duotone fa-solid fa-folder-plus"
        size="small"
        rounded
        outlined
        (click)="openCreateFolderDialog()" />
      <p-button
        label="Ajouter"
        icon="fa-duotone fa-solid fa-plus"
        size="small"
        rounded
        (click)="addMenu.toggle($event)" />
    </div>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <p-progressSpinner strokeWidth="4" />
    </div>
  } @else if (displayMode() === 'card') {
    @if (filteredFolders().length > 0) {
      <section class="documents-section">
        <div class="section-header">
          <h3 class="section-title">Dossiers</h3>
          @if (breadcrumb().length > 0) {
            <nav class="breadcrumb">
              <i class="fa-solid fa-chevron-right breadcrumb-separator"></i>
              <a class="breadcrumb-item" routerLink="/documents">
                <span>Racine</span>
              </a>
              @for (item of breadcrumb(); track item.id; let last = $last) {
                <i class="fa-solid fa-chevron-right breadcrumb-separator"></i>
                @if (last) {
                  <span class="breadcrumb-item current">
                    <span>{{ item.name }}</span>
                  </span>
                } @else {
                  <a class="breadcrumb-item" [routerLink]="getFolderPath(item.id)">
                    <span>{{ item.name }}</span>
                  </a>
                }
              }
            </nav>
          }
        </div>
        <div class="folders-grid">
          @for (folder of filteredFolders(); track folder._id) {
            <app-card-container
              [dragging]="draggedItem()?.id === folder._id"
              [dropTarget]="isDropTarget(folder._id)"
              draggable="true"
              (dragstart)="onDragStart($event, folder._id, 'folder', folder.name)"
              (dragend)="onDragEnd()"
              (dragover)="onDragOver($event, folder._id)"
              (dragleave)="onDragLeave()"
              (drop)="onDrop($event, folder._id)">
              <a
                class="card-link"
                [routerLink]="getFolderPath(folder._id)"
                (contextmenu)="onContextMenu($event, folder._id, 'folder', folder.name); docContextMenu.show($event)">
                <div class="card-icon" [style.background-color]="folder.color + '20'">
                  <i class="fa-duotone fa-solid fa-folder" [style.color]="folder.color"></i>
                </div>
                <div class="card-content">
                  <span class="card-title">{{ folder.name }}</span>
                  <span class="card-meta">{{ folder.referenceCount }} fichier{{ folder.referenceCount > 1 ? 's' : '' }}</span>
                </div>
              </a>
            </app-card-container>
          }
        </div>
      </section>
    }

    @if (filteredFiles().length > 0) {
      <section class="documents-section">
        <div class="section-header">
          <h3 class="section-title">Fichiers</h3>
          @if (breadcrumb().length > 0 && filteredFolders().length === 0) {
            <nav class="breadcrumb">
              <i class="fa-solid fa-chevron-right breadcrumb-separator"></i>
              <a class="breadcrumb-item" routerLink="/documents">
                <span>Racine</span>
              </a>
              @for (item of breadcrumb(); track item.id; let last = $last) {
                <i class="fa-solid fa-chevron-right breadcrumb-separator"></i>
                @if (last) {
                  <span class="breadcrumb-item current">
                    <span>{{ item.name }}</span>
                  </span>
                } @else {
                  <a class="breadcrumb-item" [routerLink]="getFolderPath(item.id)">
                    <span>{{ item.name }}</span>
                  </a>
                }
              }
            </nav>
          }
          <span class="section-count">{{ filesCount() }} fichier{{ filesCount() > 1 ? 's' : '' }}</span>
        </div>
        <div class="files-grid">
          @for (file of filteredFiles(); track file._id) {
            <app-card-container
              layout="column"
              [dragging]="draggedItem()?.id === file._id"
              draggable="true"
              (dragstart)="onDragStart($event, file._id, 'file', file.name)"
              (dragend)="onDragEnd()">
              <div
                class="file-content"
                (contextmenu)="onContextMenu($event, file._id, 'file', file.name, file.documentId); docContextMenu.show($event)">
                <div class="file-preview">
                  <i [class]="getFileIcon(file.fileType)" [style.color]="getFileIconColor(file.fileType)"></i>
                </div>
                <div class="card-content">
                  <span class="card-title" [title]="file.name">{{ file.name }}</span>
                  <div class="card-meta-row">
                    <span>{{ formatFileSize(file.size ?? 0) }}</span>
                    <span>{{ file.createdAt | date:'dd/MM/yyyy' }}</span>
                  </div>
                </div>
              </div>
            </app-card-container>
          }
        </div>
      </section>
    }

    @if (filteredFolders().length === 0 && filteredFiles().length === 0) {
      <div class="empty-state">
        <i class="fa-duotone fa-solid fa-folder-open"></i>
        <p>Aucun document trouvé</p>
      </div>
    }
  } @else {
    <div class="table-view">
      @if (filteredFolders().length > 0 || filteredFiles().length > 0) {
        @if (breadcrumb().length > 0) {
          <div class="section-header">
            <h3 class="section-title">Documents</h3>
            <nav class="breadcrumb">
              <i class="fa-solid fa-chevron-right breadcrumb-separator"></i>
              <a class="breadcrumb-item" routerLink="/documents">
                <span>Racine</span>
              </a>
              @for (item of breadcrumb(); track item.id; let last = $last) {
                <i class="fa-solid fa-chevron-right breadcrumb-separator"></i>
                @if (last) {
                  <span class="breadcrumb-item current">
                    <span>{{ item.name }}</span>
                  </span>
                } @else {
                  <a class="breadcrumb-item" [routerLink]="getFolderPath(item.id)">
                    <span>{{ item.name }}</span>
                  </a>
                }
              }
            </nav>
          </div>
        }
        <table class="documents-table">
          <thead>
            <tr>
              <th class="col-name">Nom</th>
              <th class="col-size">Taille</th>
              <th class="col-date">Modifié le</th>
              <th class="col-actions"></th>
            </tr>
          </thead>
          <tbody>
            @for (folder of filteredFolders(); track folder._id) {
              <tr
                class="document-row folder-row"
                [class.drop-target]="isDropTarget(folder._id)"
                [class.dragging]="draggedItem()?.id === folder._id"
                draggable="true"
                (dragstart)="onDragStart($event, folder._id, 'folder', folder.name)"
                (dragend)="onDragEnd()"
                (dragover)="onDragOver($event, folder._id)"
                (dragleave)="onDragLeave()"
                (drop)="onDrop($event, folder._id)"
                [routerLink]="getFolderPath(folder._id)"
                (contextmenu)="onContextMenu($event, folder._id, 'folder', folder.name); docContextMenu.show($event)">
                <td class="col-name">
                  <div class="document-info">
                    <div class="document-icon" [style.background-color]="folder.color + '20'">
                      <i class="fa-duotone fa-solid fa-folder" [style.color]="folder.color"></i>
                    </div>
                    <span class="document-name">{{ folder.name }}</span>
                  </div>
                </td>
                <td class="col-size">
                  <span class="document-meta">{{ folder.referenceCount }} fichier{{ folder.referenceCount > 1 ? 's' : '' }}</span>
                </td>
                <td class="col-date">-</td>
                <td class="col-actions" (click)="$event.stopPropagation()">
                  <p-button
                    icon="fa-duotone fa-solid fa-ellipsis-vertical"
                    rounded
                    text
                    severity="secondary"
                    size="small"
                    (click)="onContextMenu($event, folder._id, 'folder', folder.name); docContextMenu.show($event)" />
                </td>
              </tr>
            }
            @for (file of filteredFiles(); track file._id) {
              <tr
                class="document-row file-row"
                [class.dragging]="draggedItem()?.id === file._id"
                draggable="true"
                (dragstart)="onDragStart($event, file._id, 'file', file.name)"
                (dragend)="onDragEnd()"
                (contextmenu)="onContextMenu($event, file._id, 'file', file.name, file.documentId); docContextMenu.show($event)">
                <td class="col-name">
                  <div class="document-info">
                    <div class="document-icon" [style.background-color]="getFileIconColor(file.fileType) + '20'">
                      <i [class]="getFileIcon(file.fileType)" [style.color]="getFileIconColor(file.fileType)"></i>
                    </div>
                    <span class="document-name">{{ file.name }}</span>
                  </div>
                </td>
                <td class="col-size">
                  <span class="document-meta">{{ formatFileSize(file.size ?? 0) }}</span>
                </td>
                <td class="col-date">{{ file.createdAt | date:'dd/MM/yyyy' }}</td>
                <td class="col-actions" (click)="$event.stopPropagation()">
                  <p-button
                    icon="fa-duotone fa-solid fa-ellipsis-vertical"
                    rounded
                    text
                    severity="secondary"
                    size="small"
                    (click)="onContextMenu($event, file._id, 'file', file.name, file.documentId); docContextMenu.show($event)" />
                </td>
              </tr>
            }
          </tbody>
        </table>
      } @else {
        <div class="empty-state">
          <i class="fa-duotone fa-solid fa-folder-open"></i>
          <p>Aucun document trouvé</p>
        </div>
      }
    </div>
  }
</div>

<!-- Dialogs -->
<app-create-folder-dialog
  #createFolderDialog
  (folderCreated)="onFolderCreated($event)" />

<app-upload-files-dialog
  #uploadFilesDialog
  (filesUploaded)="onFilesUploaded($event)" />

<app-import-url-dialog
  #importUrlDialog
  (urlImported)="onUrlImported($event)" />

<app-move-document-dialog
  #moveDocumentDialog
  (documentMoved)="onDocumentMoved($event)" />

<app-clone-document-dialog
  #cloneDocumentDialog
  (documentCloned)="onDocumentCloned($event)" />

<app-delete-document-dialog
  #deleteDocumentDialog
  (documentDeleted)="onDocumentDeleted($event)" />

<app-share-dialog
  #shareDialog
  (permissionsChanged)="onPermissionsChanged($event)" />

<!-- Context Menu -->
<p-contextMenu #docContextMenu [model]="contextMenuItems()" />
