<app-create-flow-dialog (submitted)="onFlowCreated($event)" />
<app-create-flow-template-dialog (submitted)="onFlowTemplateCreated($event)" />

<div class="page-table__wrapper">
    <div class="page-table__wrapper__table-toolbar">
        <app-table-toolbar searchFieldPlaceholder="Rechercher un flow..." [(view)]="currentView" [multipleViews]="true"
            storageKey="flows" [actions]="toolbarActions()" (search)="onSearch($event)">
            <div toolbarFilters>
                <p-select [options]="statusOptions" optionLabel="label" placeholder="Filtrer par statut"
                    [(ngModel)]="selectedStatus" size="small" (onChange)="filterByStatus()" />
            </div>
        </app-table-toolbar>
    </div>
    @if (!flows.length) {
    <app-no-results icon="fa-solid fa-diagram-project" title="Aucun flow disponible"
        description="Créez votre premier flow pour commencer." />
    } @else if (currentView === 'card') {
    <div class="page-table__wrapper__grid">
        <app-grid minItemWidth="278px">
            @for (flow of flows; track flow.id) {
            <app-flow-item [flow]="flow" (openFlow)="openFlowEditor($event)" />
            }
        </app-grid>
    </div>
    } @else {
    <div class="page-table__wrapper__table">
        <p-table [value]="flows" [tableStyle]="{ 'min-width': '50rem' }">
            <ng-template #header>
                <tr>
                    <th>Statut</th>
                    <th>Nom</th>
                    @if (isAllTab()) {
                        <th>Référence</th>
                    }
                    <th>Version</th>
                    <th>Créé par</th>
                    <th>Date de création</th>
                    <th></th>
                </tr>
            </ng-template>
            <ng-template #body let-flow>
                <tr class="clickable-row" (click)="openFlowEditor(flow)">
                    <td><app-pulsing-dot [active]="flow.status !== 'inactive'"
                            [color]="flow.status === 'active' ? 'var(--p-green-500)' : flow.status === 'error' ? 'var(--p-red-500)' : 'var(--p-gray-400)'" />
                    </td>
                    <td>{{ flow.name }}</td>
                    @if (isAllTab()) {
                        <td>{{ flow.reference }}</td>
                    }
                    <td>{{ flow.version }}</td>
                    <td>{{ flow.createdBy.name }}</td>
                    <td>{{ flow.createdAt | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <p-button icon="fa-solid fa-ellipsis-vertical" size="small" text rounded
                            severity="secondary" (click)="$event.stopPropagation()"></p-button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
    }
</div>

<div class="flow-editor__wrapper" [class.active]="isFlowEditorOpen()">
    @if (isFlowEditorOpen()) {
    <app-gflow (close)="closeFlowEditor()" (saveFlow)="onFlowSaved($event)" />
    }
</div>
