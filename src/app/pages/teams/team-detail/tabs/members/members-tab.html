<div class="members-tab">
  <div class="members-toolbar">
    <div class="toolbar-left">
      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="fa-duotone fa-solid fa-magnifying-glass"></i>
        </p-inputgroup-addon>
        <input
          type="text"
          pInputText
          placeholder="Rechercher"
          [ngModel]="searchQuery()"
          (ngModelChange)="onSearchChange($event)"
          pSize="small" />
      </p-inputgroup>

      <p-divider layout="vertical" />

      <p-select
        [options]="filterOptions"
        [ngModel]="filterType()"
        (ngModelChange)="onFilterChange($event)"
        optionLabel="label"
        optionValue="value"
        size="small"
        appendTo="body"/>

      <p-divider layout="vertical" />

      <p-button
        [label]="displayMode() === 'table' ? 'Vue galerie' : 'Vue tableau'"
        [icon]="displayMode() === 'table' ? 'fa-duotone fa-solid fa-grid-2' : 'fa-duotone fa-solid fa-table'"
        size="small"
        severity="secondary"
        text
        (click)="toggleDisplayMode()" />
    </div>

    <div class="toolbar-right">
      <p-button
        label="Ajouter un membre"
        icon="fa-duotone fa-solid fa-plus"
        size="small"
        rounded
        (click)="openAddMemberDialog()" />
    </div>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <p-progressSpinner strokeWidth="4" />
    </div>
  } @else if (displayMode() === 'card') {
    @if (filteredMembers().length > 0) {
      <section class="members-section">
        <div class="section-header">
          <h3 class="section-title">Membres</h3>
          <span class="section-count">{{ membersCount() }} membre{{ membersCount() > 1 ? 's' : '' }}</span>
        </div>
        <div class="members-grid">
          @for (member of filteredMembers(); track member.userId) {
            <app-card-container
              layout="column"
              (contextmenu)="onMemberContextMenu($event, member); contextMenu.show($event)">
              <div class="card-header">
                <div class="card-icon member">
                  <i class="fa-duotone fa-solid fa-user"></i>
                </div>
                @if (member.role === 'admin') {
                  <div class="owner-badge">
                    <i class="fa-solid fa-crown"></i>
                  </div>
                }
              </div>
              <div class="card-content">
                <span class="card-title">{{ member.firstname }} {{ member.lastname }}</span>
                <span class="card-meta">{{ member.email }}</span>
              </div>
              <div class="card-footer">
                <p-tag [value]="getRoleLabel(member.role)" [severity]="getRoleSeverity(member.role)" />
              </div>
            </app-card-container>
          }
        </div>
      </section>
    } @else {
      <div class="empty-state">
        <i class="fa-duotone fa-solid fa-users"></i>
        <p>Aucun membre trouvé</p>
      </div>
    }
  } @else {
    <div class="table-view">
      @if (filteredMembers().length > 0) {
        <table class="members-table">
          <thead>
            <tr>
              <th class="col-name">Nom</th>
              <th class="col-email">Email</th>
              <th class="col-role">Rôle</th>
              <th class="col-actions"></th>
            </tr>
          </thead>
          <tbody>
            @for (member of filteredMembers(); track member.userId) {
              <tr
                class="item-row member-row"
                (contextmenu)="onMemberContextMenu($event, member); contextMenu.show($event)">
                <td class="col-name">
                  <div class="item-info">
                    <div class="item-icon member">
                      <i class="fa-duotone fa-solid fa-user"></i>
                    </div>
                    <span class="item-name">{{ member.firstname }} {{ member.lastname }}</span>
                    @if (member.role === 'admin') {
                      <div class="owner-badge-small">
                        <i class="fa-solid fa-crown"></i>
                      </div>
                    }
                  </div>
                </td>
                <td class="col-email">{{ member.email }}</td>
                <td class="col-role">
                  <p-tag [value]="getRoleLabel(member.role)" [severity]="getRoleSeverity(member.role)" />
                </td>
                <td class="col-actions" (click)="$event.stopPropagation()">
                  <p-button
                    icon="fa-duotone fa-solid fa-ellipsis-vertical"
                    rounded
                    text
                    severity="secondary"
                    size="small"
                    (click)="onMemberContextMenu($event, member); contextMenu.show($event)" />
                </td>
              </tr>
            }
          </tbody>
        </table>
      } @else {
        <div class="empty-state">
          <i class="fa-duotone fa-solid fa-users"></i>
          <p>Aucun membre trouvé</p>
        </div>
      }
    </div>
  }
</div>

<app-add-member-dialog
  #addMemberDialog
  (memberAdded)="onMemberAdded($event)" />

<!-- Context Menu -->
<p-contextMenu #contextMenu [model]="contextMenuItems()" />
